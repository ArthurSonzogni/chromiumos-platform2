# Copyright 2022 The ChromiumOS Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description "OpenCL shader compilation cacher"
author "chromium-os-dev@chromium.org"

start on start-user-session and stopped imageloader-init
stop on stopping ui

oom score -100

expect fork

# This service will load the ML processing shaders and run a
# tuning process to compile and optimize them for that specific
# device GPU. This happens on the GPU itself, and so the sandbox
# needs access to that device.

# Minijail settings:
# -i exit immediately after fork
# -n Set no_new_privs
# -u run as user ml-core
# -g run as group ml-core
# -G to be in video group to access /dev/video*.
# --profile=minimalistic-mountns to set up a mostly empty pivot root
#
# Namespaces:
# -N enter new cgroup namespace
# -p enter new pid namespace
# -l enter new IPC namespace
# -e enter new network namespace
# -v enter new mount namespace
#
# Mounts:
# -Kslave to propagate mount events (like DLC installation)
# -b /dev/dri for GPU access
# -k to mount tmpfs at /run
# -k to mount tmpfs at /sys
# -k to mount tmpfs at /var
# -k to mount /var/lib/ml_core/opencl_cache for storage (writable)
# -k to mount /run/image-loader for DLC
# -k to mount /run/camera to check for force_enable_effects file
# -b /sys/dev/char, /sys/devices to perform device enumeration
# -b /run/dbus for DBus

exec minijail0 -i -n -u ml-core -g ml-core -G \
    -N -p -l -e -v -Kslave \
    --profile=minimalistic-mountns \
    -b /dev/dri  \
    -k 'tmpfs,/run,tmpfs,MS_NOSUID|MS_NODEV|MS_NOEXEC' \
    -k 'tmpfs,/sys,tmpfs,MS_NODEV|MS_NOEXEC|MS_NOSUID,mode=755' \
    -k 'tmpfs,/var,tmpfs,MS_NOSUID|MS_NODEV|MS_NOEXEC' \
    -k '/var/lib/ml_core/opencl_cache,/var/lib/ml_core/opencl_cache,none,MS_BIND|MS_REC' \
    -k '/run/imageloader,/run/imageloader,none,MS_BIND|MS_REC|MS_NOSUID|MS_NODEV' \
    -k '/run/camera,/run/camera,none,MS_BIND|MS_REC|MS_NOSUID|MS_NODEV' \
    -b /sys/dev/char -b /sys/devices \
    -b /run/dbus \
    -S /usr/share/policy/opencl-cacher-amd64.policy \
    -- /usr/bin/opencl_cacher
