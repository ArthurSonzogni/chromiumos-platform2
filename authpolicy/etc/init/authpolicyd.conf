# Copyright 2016 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description     "Authpolicy daemon"
author          "chromium-os-dev@chromium.org"

# The service is started by Chrome via UpstartClient::StartAuthPolicyService().
stop on stopping ui
respawn

# krb5_machine.keytab and smb.conf live in /var/lib/authpolicyd. All other files
# are written to /tmp which is created fresh for each authpolicyd invocation.
pre-start script
  mkdir -m 0700 -p /var/lib/authpolicyd
  chown -R authpolicyd:authpolicyd /var/lib/authpolicyd
end script


# Minijail actually forks off the desired process.
expect fork

# -e is not specified because the service needs to connect to an AD server to
# join a domain, authenticate users and fetch user and device policies.
exec minijail0 -i -I -p -l -r -v -t -u authpolicyd -g authpolicyd \
    /usr/sbin/authpolicyd

# Wait for daemon to claim its D-Bus name before transitioning to started.
post-start exec gdbus wait --system --timeout 15 org.chromium.AuthPolicy
