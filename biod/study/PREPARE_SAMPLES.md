# Prepare Captured Samples for Analysis

This doc outlines the steps that need to be taken to prepare the samples for the
analysis tool.

Assume the following definitions:

*   `<PATH_TO_SAMPLES>` is the root directory of of the samples that contains
    the participant ID directories.
*   `<PRIVATE_KEY_PASSWORD>` is the password for the
    `chromeos-fpstudy-private.gpg` generated by `gen-key-pair.sh`.
*   `<PATH_TO_PRIVATE_KEY>` is the path to the `chromeos-fpstudy-private.gpg`
    created by `gen-key-pair.sh`.

## 1. Decrypt Samples

```bash
cd <PATH_TO_SAMPLES>
PATH=~/chromiumos/src/platform2/biod/study:${PATH}
# For single threaded operation, use the following command:
#fpstudy.py decrypt --password '<PRIVATE_KEY_PASSWORD>' <PATH_TO_PRIVATE_KEY> .
# For parallel operation, use the following command:
ls ./ | xargs -P$(nproc) -L1 fpstudy.py decrypt --password '<PRIVATE_KEY_PASSWORD>' <PATH_TO_PRIVATE_KEY>
```

## 2. Restructure Sample Directories

Restructure the sample directories from
`./<PARTICIPANT_ID>/<PARTICIPANT_GROUP>/<FINGER_ID>/<SAMPLE_FILE>` to
`./<PARTICIPANT_ID>/<FINGER_ID>/<SAMPLE_FILE>`.

We remove the intermediate participant group directory from each participant's
directory, since the analysis tools do not know how to interpret the participant
group.

```bash
cd <PATH_TO_SAMPLES>
for pid in ./*; do \
mv -v "${pid}"/[A-Z]/* "${pid}"/; \
rmdir -v "${pid}"/[A-Z]; \
done
```

## 3. Generate PNG Samples [optional]

Generating PNG samples can help debug invalid samples.

```bash
cd <PATH_TO_SAMPLES>
PATH=~/chromiumos/src/platform2/biod/study:${PATH}
# For single threaded operation, use the following command:
#fpstudy.py convert <FPC1025|FPC1145> png .
# For parallel operation, use the following command:
ls ./ | xargs -P$(nproc) -L1 fpstudy.py convert <FPC1025|FPC1145> png
```
