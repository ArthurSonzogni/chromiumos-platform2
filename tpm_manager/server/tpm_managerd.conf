# Copyright 2015 The ChromiumOS Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description     "Chromium OS device tpm_manager service."
author          "chromium-os-dev@chromium.org"

start on started boot-services and started tcsd
stop on stopping boot-services
respawn

oom score -100

tmpfiles /usr/lib/tmpfiles.d/tpm_manager.conf

pre-start script
  # Migration errors are non-fatal for the daemon startup.
  local_data_migration || true
  check_tpm_preinit_condition || true
end script

expect fork
script
  # TODO(b/259005156): refactor this section for minijail mount setup. We can
  #   export those as a separate upstart event so we don't have to do it for
  #   every single miniajil setup, and can be shared with all other daemons.
  # Some bind mount arguments should be set conditionally.
  set --
  # TPM1.2 devices need to read /run/tcsd/tcsd.socket.
  if [ -d "/run/tcsd" ]; then
    set -- "$@" -b /run/tcsd
  fi
  # Files in /sys/class/tpm/tpm0 need to be readable for TPM_DYNAMIC case. Note
  # that some flex devices may not have tpm, so we bind mount it conditionally.
  if [ -d "/sys/class/tpm/tpm0" ]; then
    set -- "$@" -b /sys/class/tpm/tpm0
  fi
  # Same for /sys/class/dmi/id files.
  if [ -d "/sys/class/dmi/id" ]; then
    set -- "$@" -b /sys/class/dmi/id
  fi
  # We need /mnt/stateful_partition/unencrypted/profraws with write capability
  # to dump profraw files when we have USE=profiling flag set.
  if [ -d "/mnt/stateful_partition/unencrypted/profraws" ]; then
    set -- "$@" -b /mnt/stateful_partition/unencrypted/profraws,,1
  fi

  exec minijail0 --uts -l -N -p -n -i -I                                       \
  --profile minimalistic-mountns                                             \
  -k 'tpmfs,/run,tmpfs,MS_NODEV|MS_NOEXEC|MS_NOSUID,mode=755,size=10M'       \
  -b /run/dbus                                                               \
  -b /run/tpm_manager                                                        \
  -k 'tmpfs,/var,tmpfs,MS_NODEV|MS_NOEXEC|MS_NOSUID,mode=755,size=10M'       \
  -b /var/lib/tpm_manager,,1                                                 \
  -b /var/lib/metrics,,1                                                     \
  -k 'tmpfs,/sys,tmpfs,MS_NODEV|MS_NOEXEC|MS_NOSUID,mode=755,size=10M'       \
  -b /mnt/stateful_partition,,1                                              \
  -b /mnt/stateful_partition/unencrypted                                     \
  "$@"                                                                       \
  -u tpm_manager -G -g tpm_manager                                           \
  -S /usr/share/policy/tpm_managerd-seccomp.policy                           \
  -- /usr/sbin/tpm_managerd
end script

# Wait for daemon to claim its D-Bus name.
post-start exec minijail0 -u tpm_manager -G \
    /usr/bin/gdbus wait --system --timeout 15 org.chromium.TpmManager
