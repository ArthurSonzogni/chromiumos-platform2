# Copyright 2018 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Starts a command for reading from the kmsg FIFO."
author        "chromium-os-dev@chromium.org"

stop on stop-arc-instance or stopping ui

env LOGFILE=/var/log/android.kmsg

script
  exec > $LOGFILE 2>&1
  echo "$(date --rfc-3339=ns): start arc-kmsg-logger"
  while true ; do
    # If cat fails, terminate the job. If cat exits with 0 on EOF, respawn the
    # process after a short sleep without clobbering the LOGFILE.
    sudo -u android-root cat /run/arc/android.kmsg.fifo
    sleep 1
  done
end script

post-stop script
  exec >> $LOGFILE 2>&1
  echo "$(date --rfc-3339=ns): Post-stop arc-kmsg-logger"
end script
