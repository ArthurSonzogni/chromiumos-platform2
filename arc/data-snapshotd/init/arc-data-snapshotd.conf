# Copyright 2020 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description     "Start arc-data-snapshotd daemon in Chrome OS."
author          "chromium-os-dev@chromium.org"

# Chrome browser manages a lifetime of arc-data-snapshotd daemon via upstart.
# The daemon is responsible for ARC snapshot of data/ directory management.
stop on stopping ui

# Killable for memory leaks.
oom score -100

respawn
# If the job respawns 3 times in 10 seconds, stop trying.
respawn limit 3 10

env SNAPSHOT_DIR=/mnt/stateful_partition/encrypted/var/cache/arc-data-snapshot
import RESTART_FRECON

pre-start script
  if [ ! -d "${SNAPSHOT_DIR}" ]; then
    mkdir -m 755 "${SNAPSHOT_DIR}"
    mkdir -m 755 "${SNAPSHOT_DIR}/images"

    chown -R arc-data-snapshotd:arc-data-snapshotd "${SNAPSHOT_DIR}"

    cp /usr/share/chromeos-assets/images/boot_message_light.png \
       "${SNAPSHOT_DIR}/images/boot_message.png"
  fi

  mkdir -p -m 550 /run/arc-data-snapshotd
  cp /home/.shadow/salt /run/arc-data-snapshotd/salt
  chown -R arc-data-snapshotd:arc-data-snapshotd /run/arc-data-snapshotd
end script

# Used jailing parameters:
#   -c: capabalities:
#       cap_dac_override,cap_fowner: let arc-data-snapshotd user to
#       copy/remove/stat android-data regardless of file ownership;
#       cap_sys_admin: let arc-data-snapshotd user to modify security
#       attributes of the copied files;
#   --ambient: let subprocesses inherit capabilities;
#   -e: new network namespace;
#   -l: new IPC namespace;
#   -n: the no_new_privs bit;
#   -p: enter a new PID namespace;
#   -I: runs program as init inside a new PID namespace;
#   -v: new VFS namespace;
#   --uts: new UTS/hostname namespace;
#   -u, -g: user account and group;
#   -S: apply seccomp filters.
script
  logger -t "${UPSTART_JOB}" "Start arc-data-snapshotd"
  set -x

  # Show update_arc_data_snapshot UI screen if needed.
  # TODO(pbond): remove this frecon restart once it is no longer needed.
  # Currently, boot-splash screen is not able to be updated via esc sequence.
  if [ "${RESTART_FRECON}" = "1" ]; then
    IMAGE_BACKGROUND_RGB=fefefe IMAGE_TEXT_COLOR=Black \
    ASSETS_IMAGE_PATH="${SNAPSHOT_DIR}/images" MESSAGE_OPTIONS=--markup \
    chromeos-boot-alert update_arc_data_snapshot
  fi

  exec minijail0 -c 'cap_dac_override,cap_fowner,cap_sys_admin+eip' --ambient \
      -e -l -n -p -I -v --uts -u arc-data-snapshotd -g arc-data-snapshotd \
      -S /usr/share/policy/arc-data-snapshotd-seccomp.policy \
      -- /usr/bin/arc-data-snapshotd
end script

# Wait for daemon to claim its D-Bus name before transitioning to started.
post-start exec minijail0 -u arc-data-snapshotd -g arc-data-snapshotd \
    /usr/bin/gdbus wait --system --timeout 15 org.chromium.ArcDataSnapshotd

post-stop script
  logger -t "${UPSTART_JOB}" "Post-stop arc-data-snapshotd"
  display_boot_message action restore_frecon
end script
