# Copyright 2018 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Run /system/bin/adbd in a container"
author        "chromium-os-dev@chromium.org"

# Note: Lifecycle of this job is managed by arc-setup job.
stop on stop-arc-instance or stopping ui

env LOGFILE=/var/log/arc-adbd.log
env PIDFILE=/run/arc/adbd.pid
env ADBD_ROOTFS_DIR=\
/opt/google/containers/arc-adbd/mountpoints/container-root
env RUNTIME_DIR=/run/arc/adbd
env SHELL_UGID=657360

script
  exec > $LOGFILE 2>&1
  echo "$(date --rfc-3339=ns): Starting arc-adbd"
  set -x

  # Clean up a stale pid file if exists.
  rm -f $PIDFILE

  # Start constructing minijail0 args...
  args=""

  # Use a minimalistic mount namespace.
  args="$args --profile minimalistic-mountns"

  # Enter a new mount namespace.
  args="$args -v"

  # Enter a new network namespace.
  args="$args -e"

  # Enter a new PID namespace.
  args="$args -p"

  # Skip remounting as private.
  args="$args -K"

  # Enter a new IPC namespace.
  args="$args -l"

  # Create PID file at $PIDFILE.
  args="$args -f $PIDFILE"

  # Set up mount points.
  args="$args -b /sys,/sys"
  args="$args -k tmpfs,/run,tmpfs,0xe"
  args="$args -k /run/arc/adbd,/run/arc/adbd,none,0x1000" # MS_BIND
  args="$args -k none,/run/arc/adbd,none,0x100000" # MS_SHARED

  # Above mount points work confuses the binary path detection in libminijail.
  # Explicitly declare /system/bin/adbd is a static binary.
  args="$args -T static"

  # Finally, specify the command line arguments.
  args="$args -- /usr/sbin/arc-adbd --serialnumber=${SERIALNUMBER}"

  exec capsh --drop=CAP_BLOCK_SUSPEND,CAP_WAKE_ALARM,CAP_SYS_BOOT \
    -- -c "minijail0 $args"
end script

post-stop script
  exec >> $LOGFILE 2>&1
  echo "$(date --rfc-3339=ns): Post-stop arc-adbd"

  set +e -x

  # Perform best-effort unmounting of the bulk endpoints.
  umount --lazy "${RUNTIME_DIR}"/ep1
  umount --lazy "${RUNTIME_DIR}"/ep2
  rm -f "${RUNTIME_DIR}/"*
end script
