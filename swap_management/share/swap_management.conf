# Copyright 2022 The ChromiumOS Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description     "ChromiumOS swap management daemon"
author          "ctshao@chromium.org"

stop on stopping ui
respawn

# Validate filesystem.
tmpfiles /usr/lib/tmpfiles.d/swap_management.conf

# Do not respawn if the service is terminated on purpose.
normal exit 0

# OOM score picked based on out-of-memory-handling guidelines.
# https://www.chromium.org/chromium-os/chromiumos-design-docs/out-of-memory-handling/
oom score -900

# TODO(b/261074016): Get away with using -c CAP_SYS_ADMIN for the mount and swap
# operations.
# Need access to /proc, /sys, /dev to perform swap operations.
# Need (writable) access to /var/lib/swap to set the zram size.
# Need (writable) access to /var/lib/metrics to write UMA data.
# Need (writable) access to
# /mnt/stateful_partition/unencrypted/userspace_swap.tmp to create actual
# writeback space.
# Need access to /run/dbus for DBus communications.
# Need (writable) access to /sys/kernel/mm/chromeos-low_mem to initialize the
# MM tunable.
# Need (writable) access to /proc/sys/vm to initialize the MM tunable.
exec minijail0 -i \
    --uts \
    -v -t -n -P /mnt/empty \
    -b / \
    -k '/dev,/dev,none,MS_BIND|MS_REC' \
    -k 'tmpfs,/var,tmpfs,MS_NODEV|MS_NOEXEC|MS_NOSUID,mode=755,size=10M' \
    -b /var/lib/swap,,1 \
    -b /var/lib/metrics,,1 \
    -k 'tmpfs,/mnt,tmpfs,MS_NODEV|MS_NOEXEC|MS_NOSUID,mode=755,size=10M' \
    -b /mnt/stateful_partition/unencrypted/userspace_swap.tmp,,1 \
    -k 'tmpfs,/run,tmpfs,MS_NODEV|MS_NOEXEC|MS_NOSUID,mode=755,size=10M' \
    -b /run/dbus \
    -k '/sys,/sys,none,MS_BIND|MS_REC' \
    -b /sys/kernel/mm/chromeos-low_mem,,1 \
    -k 'none,/proc,proc,MS_NOSUID|MS_NODEV|MS_NOEXEC' \
    -b /proc/sys/vm,,1 \
    -- /usr/sbin/swap_management
