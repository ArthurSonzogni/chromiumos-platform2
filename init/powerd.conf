# Copyright (c) 2010 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Start powerd after udev"
author        "chromium-os-dev@chromium.org"

start on started udev and started ui
stop on starting halt or starting reboot

env HOME=/home/chronos
env LOG_DIR=/var/log/power_manager
env PREFS_DIR=/var/lib/power_manager
env ORIG_PREFS_DIR=/usr/share/power_manager
env XAUTHORITY=/home/chronos/.Xauthority
env DISPLAY=:0.0
env USER_ID=1000

respawn
respawn limit 20 60  # if the job respawns 20 times in 60 seconds, stop trying.

script

MACH=`uname -m`
if [ "$MACH" = "i686" -o "$MACH" = "x86_64" ]; then
  # Identify the I2C bus and address, and load the driver.
  # A failure here must _not_ keep powerd from starting.
  echo tsl2563 0x29 > /sys/class/i2c-adapter/i2c-2/new_device || :
fi

mkdir -p ${LOG_DIR} ${PREFS_DIR}
if [ ! ${ORIG_PREFS_DIR} -ot ${PREFS_DIR}/.pref-sync ]; then
  # Copy new preferences as they are added
  cp -u ${ORIG_PREFS_DIR}/* ${PREFS_DIR}
  touch ${PREFS_DIR}/.pref-sync
  chown -R ${USER_ID} ${PREFS_DIR}
fi
chown ${USER_ID} ${LOG_DIR} /sys/class/backlight/*/* /sys/power/state
cd ${HOME}
exec /sbin/minijail --uid=${USER_ID} -- /bin/dash -c '                    \
  /usr/bin/powerd                                                         \
    --prefs_dir=${PREFS_DIR}                                              \
    --log_dir=${LOG_DIR}                                                  \
  > ${LOG_DIR}/powerd.out 2>&1; sleep 2'

end script
