# Copyright (c) 2010 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# Trousers daemon, which talks to the TPM (or the TPM emulator).
# Started directly from tpm-probe.

stop on starting halt or starting reboot

respawn
expect fork

pre-start script
  # Temporary fix for BIOS bug.  Very Soon[tm] this fix will be in the BIOS.
  status=$(TPM_DEVICE_PATH=/dev/tpm /usr/bin/tpm_init_temp_fix)
  if [ "$status" = "reboot" ] ; then
    /sbin/reboot
  fi
  # end of temporary fix

  if [ "0" = $(cat /sys/class/misc/tpm0/device/owned) ]; then
    # clean up any existing tcsd state.
    rm -rf /var/lib/tpm/*
  fi
end script

exec /usr/sbin/tcsd
