# Copyright (c) 2009 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Chrome OS user interface"
author        "chromium-os-dev@googlegroups.com"

start on stopping startup
stop on starting halt or starting reboot

respawn
respawn limit 3 10  # if the job respawns 3 times in 10 seconds, stop trying.
# Uncomment line below to output to VT02
#console output

env LIBCROS_LOG=/var/log/libcros_log
env CHROME_LOG=/home/chronos/chrome_log
env CHROME_OLD_LOGS=/var/log/chrome_old_logs

pre-start script

X_SOCKET_DIR=/tmp/.X11-unix
X_ICE_DIR=/tmp/.ICE-unix
mkdir -p "$X_SOCKET_DIR" "$X_ICE_DIR"
chown root:root "$X_SOCKET_DIR" "$X_ICE_DIR"
chmod 1777 "$X_SOCKET_DIR" "$X_ICE_DIR"

# XKB writes keymaps here; otherwise things like Ctrl-Alt-Fx VT switching
# don't work.
mkdir -p /var/lib/xkb

# Make sure we we can easily track UI state.
rm -rf /var/run/state/
mkdir -p /var/run/state

# Enable us to keep track of the user's chosen TZ.
# Default to Pacific timezone if we don't have one set
TIMEZONE_DIR=/var/lib/timezone
TIMEZONE_FILE=${TIMEZONE_DIR}/localtime
if [ ! -f "${TIMEZONE_FILE}" ]; then
  mkdir -p ${TIMEZONE_DIR}
  ln -sf /usr/share/zoneinfo/US/Pacific ${TIMEZONE_FILE}
  chown -R chronos:chronos ${TIMEZONE_DIR}
fi

# Create a directory that the window manager (running as "chronos") can
# write to.
mkdir -p /var/run/state/windowmanager
chown chronos /var/run/state/windowmanager

end script

script
LIBCROS_LOG_FILE=${LIBCROS_LOG}_$(date +%Y%m%d-%H%M%S)
ln -sf ${LIBCROS_LOG_FILE} ${LIBCROS_LOG}
/sbin/session_manager_setup.sh 2>> ${LIBCROS_LOG_FILE}
end script

post-stop script

set +e
. /sbin/killers

# Terminate any processes with files open on the mount point
kill_with_open_files_on /home/chronos/user
term_process "^X$"

# Eventually, this will take a parameter specifying which user's dir to unmount.
/usr/sbin/cryptohome --action=unmount

mkdir -p $CHROME_OLD_LOGS
chown $USER $CHROME_OLD_LOGS
mv ${LIBCROS_LOG}_* $CHROME_OLD_LOGS

end script
