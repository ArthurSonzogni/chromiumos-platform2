# Copyright (c) 2009 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Chrome OS user interface"
author        "chromium-os-dev@googlegroups.com"

start on stopping startup
stop on starting halt or starting reboot

respawn
respawn limit 3 10  # if the job respawns 3 times in 10 seconds, stop trying.

pre-start script

X_SOCKET_DIR=/tmp/.X11-unix
X_ICE_DIR=/tmp/.ICE-unix
mkdir -p "$X_SOCKET_DIR" "$X_ICE_DIR"
chown root:root "$X_SOCKET_DIR" "$X_ICE_DIR"
chmod 1777 "$X_SOCKET_DIR" "$X_ICE_DIR"

# XKB writes keymaps here; otherwise things like Ctrl-Alt-Fx VT switching
# don't work.
mkdir -p /var/lib/xkb

# Make sure we we can easily track UI state.
rm -rf /var/run/state/
mkdir -p /var/run/state

# Enable us to keep track of the user's chosen TZ.
LINK=/var/lib/localtime
[ ! -L "${LINK}" ] && ln -sf /usr/share/zoneinfo/US/Pacific "${LINK}"

# Create a directory that the window manager (running as "chronos") can
# write to.
mkdir /var/run/state/windowmanager
chown chronos /var/run/state/windowmanager

end script

exec /sbin/session_manager_setup.sh

post-stop script

set +e
. /sbin/killers

# Terminate any processes with files open on the mount point
kill_with_open_files_on /home/chronos/user
term_process "^X$"

# Eventually, this will take a parameter specifying which user's dir to unmount.
/usr/sbin/cryptohome --action=unmount

end script
