# Copyright (c) 2012 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Run the flimflam network connection manager"
author        "chromium-os-dev@chromium.org"

start on started wpasupplicant and started udev and stopped iptables and stopped ip6tables

respawn
expect fork

pre-start script
  # cleanup any links to shill's resolv.conf file.
  rm -f /var/run/flimflam/resolv.conf
  if [ -f /home/chronos/.enable_shill ]; then
    # Experimental: Use the shill connection manager instead.
    mkdir -p /var/run/shill/
    mkdir -p /var/run/flimflam/
    ln -s /var/run/shill/resolv.conf /var/run/flimflam/resolv.conf
  fi
end script

script
  DAEMONBIN="flimflamd"
  if [ -f /home/chronos/.enable_shill ]; then
    DAEMONBIN="shill"
  fi

  # -k filename: Filename to read encrypted configuration keymatter
  ARGS='-k /var/lib/whitelist/owner.key'
  # if upstart respawns us, re-push the per-user profile as done by login.conf
  if [ -f /var/run/state/logged-in ]; then
    ARGS="${ARGS} --push ~chronos/flimflam"
  fi

  # If OOBE has not completed (i.e. EULA not agreed to), do not run
  # portal checks.
  if [ ! -f /home/chronos/.oobe_completed ]; then
    ARGS="${ARGS} --portal-list ''"
  fi

  exec ${DAEMONBIN} ${ARGS}
end script

# after start, udevd can advertise to flimflam the builtin WIFI device exists.
post-start exec /sbin/udevadm trigger --action=add --sysname-match=wlan0
