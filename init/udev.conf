# Copyright (c) 2010 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# udev
#
# Start udev either when boot reaches login prompt or after a delay
# period specified in the sleep job.  Starting after the sleep job
# ensures that there is networking even if ui fails.

start on stopped boot-complete or stopped sleep

respawn
expect fork
exec /sbin/udevd --daemon

pre-start script
  # udev uses inotify to monitor the dynamic rules directory
  # /dev/.udev/rules.d, however this directory must exist before udevd
  # runs, or the inotify won't find the directory even if it is created
  # later.  This is an issue with udev-146.  Udev versions 156 and later
  # do not exhibit this problem, and for those this script is not necessary.
  if [ ! -d /dev/.udev/rules.d ]; then
    mkdir -p /dev/.udev/rules.d
  fi
end script

post-start script
  # In some systems hotplug is used before udev starts.  We need to disable it
  # so it doesn't fight with udev.
  if [ -e /proc/sys/kernel/hotplug ]; then
    echo "" > /proc/sys/kernel/hotplug
  fi

  /sbin/udevadm trigger
  /sbin/udevadm settle
end script
