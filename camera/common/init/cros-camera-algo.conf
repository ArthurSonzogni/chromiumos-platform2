# Copyright 2017 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

description   "Start camera algorithm service"
author        "chromium-os-dev@chromium.org"

start on started system-services
expect fork
respawn
respawn limit 10 5

env CHROOT_PATH=/run/camera
env SECCOMP_POLICY_FILE=/usr/share/policy/cros-camera-algo.policy

pre-start script
  set -x
  # Create directory for mounting /dev/urandom in chroot
  mkdir -p "${CHROOT_PATH}"/dev

  # Create directory for binding camera configs in chroot
  mkdir -p "${CHROOT_PATH}"/etc/camera
end script

# Enter a new mount, network, PID, IPC and cgroup namespace.
# Set -i to allow upstart to track the forked process correctly.
# Change user and group to arc-camera.
# Chroot and mount /usr, /proc and /dev/urandom.
# Set seccomp filter.
exec minijail0 -v -e -p -l -N -i -u arc-camera -g arc-camera \
               -P "${CHROOT_PATH}" -k /usr,/usr,none,0x1000 \
               -k /proc,/proc,proc,0xe \
               -k /dev/urandom,/dev/urandom,none,0x1001 \
               -b /etc/camera,/etc/camera \
               -n -L -S "${SECCOMP_POLICY_FILE}" \
               -- /usr/bin/cros_camera_algo
