{%- import "method-macro.cc.j2" as method_macro %}

{%- set class_name = "%sTestProvider"|format(interface.mojom_name) %}

std::unique_ptr<{{class_name}}> {{class_name}}::Create(
    ::diagnostics::bindings::connectivity::Context* context) {
  return std::unique_ptr<{{class_name}}>(new {{class_name}}(context));
}

{{class_name}}::{{class_name}}(
    ::diagnostics::bindings::connectivity::Context* context)
  : context_(context) {
{%- for method in interface.methods -%}
  {{method_macro.define_data_generator(
      method.mojom_name ~ "__", "context", method.response_parameters)}}
{%- endfor %}
}

void {{class_name}}::Bind(::mojo::PendingReceiver<{{
    interface.mojom_name}}> receiver) {
  receiver_set_.Add(&service_, std::move(receiver));
}

::mojo::PendingRemote<{{interface.mojom_name}}> {{class_name}}::Generate() {
  has_next_ = false;
  ::mojo::PendingReceiver<{{interface.mojom_name}}> receiver;
  auto remote = receiver.InitWithNewPipeAndPassRemote();
  receiver_set_.Add(&service_, std::move(receiver));
  return remote;
}

void {{class_name}}::RemoveReceiver(::mojo::ReceiverId receiver_id) {
  receiver_set_.Remove(receiver_id);
}

{%- for method in interface.methods %}
void {{class_name}}::{{method.mojom_name}}_Step1({{
    method_macro.declare_request_params("", method)}}) {
{#  Create callback for Step2. #}
{%-   if method.response_parameters != None -%}
  auto response_callback = base::BindOnce(
        std::move(callback)
        {%- if method.response_parameters %}, {% endif -%}
        {{method_macro.generate_params(
            method.mojom_name ~"__", method.response_parameters)}});
{%-    else -%}
  auto response_callback = base::DoNothing();
{%-    endif -%}
  auto callback_0 = base::BindOnce(
    &{{class_name}}::{{method.mojom_name}}_Step2,
    weak_factory_.GetWeakPtr(),
    std::move(response_callback));

{# TODO: Recursively check interface. #}

  auto callback_last = std::move(callback_0);
  std::move(callback_last).Run();
}

void {{class_name}}::{{method.mojom_name}}_Step2(base::OnceClosure callback) {
{%-   if method.response_parameters != None %}
    context_->local_state()->SetLastCallHasNext({{method_macro.params_has_next(
        method.mojom_name ~"__", method.response_parameters)}});
{%    else %}
  context_->local_state()->FulfillLastCallCallback();
{%    endif %}
  std::move(callback).Run();
}

{%- endfor %}
